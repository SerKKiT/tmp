#!/bin/bash

# ะะฟัะตะดะตะปัะตะผ IP ะฐะดัะตั ัะตัะฒะตัะฐ ะฐะฒัะพะผะฐัะธัะตัะบะธ
SERVER_IP=$(hostname -I | awk '{print $1}')

# ะะปััะตัะฝะฐัะธะฒะฝัะน ัะฟะพัะพะฑ ะดะปั ัะฐะทะฝัั ะะก
if [ -z "$SERVER_IP" ]; then
    SERVER_IP=$(ip route get 8.8.8.8 | awk -F"src " 'NR==1{split($2,a," ");print a[1]}')
fi

# ะัะปะธ ะฒัะต ะตัะต ะฝะต ัะดะฐะปะพัั ะพะฟัะตะดะตะปะธัั, ะธัะฟะพะปัะทัะตะผ localhost
if [ -z "$SERVER_IP" ]; then
    SERVER_IP="localhost"
fi

echo "๐ ะะฐะฟััะบ ั IP ะฐะดัะตัะพะผ: $SERVER_IP"

# ะญะบัะฟะพััะธััะตะผ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั
export SERVER_IP=$SERVER_IP

# ะะตัะตัะพะดะธะผ ะฒ ะฟะฐะฟะบั deployments
cd deployments/

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะธ ัะดะฐะปัะตะผ ัััะตััะฒัััะธะต ะบะพะฝัะตะนะฝะตัั
echo "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัััะตััะฒัััะธะต ะบะพะฝัะตะนะฝะตัั..."
docker-compose down

# ะกะพะฑะธัะฐะตะผ ะธ ะทะฐะฟััะบะฐะตะผ ะบะพะฝัะตะนะฝะตัั
echo "๐จ ะกะฑะพัะบะฐ ะธ ะทะฐะฟััะบ ะบะพะฝัะตะนะฝะตัะพะฒ..."
docker-compose up --build -d

# ะะดะตะผ ะทะฐะฟััะบะฐ ัะตัะฒะธัะพะฒ
echo "โณ ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ ัะตัะฒะธัะพะฒ..."
sleep 15

# ะัะพะฒะตััะตะผ ััะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ
echo "๐ ะกัะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ:"
docker-compose ps

# ะัะพะฒะตััะตะผ ะทะดะพัะพะฒัะต ะฟัะธะปะพะถะตะฝะธั
echo "๐ ะัะพะฒะตัะบะฐ ะทะดะพัะพะฒัั ะฟัะธะปะพะถะตะฝะธั..."
curl -f http://localhost:8080/api/health 2>/dev/null && echo "โ ะัะฝะพะฒะฝะพะต ะฟัะธะปะพะถะตะฝะธะต ัะฐะฑะพัะฐะตั" || echo "โ ะัะฝะพะฒะฝะพะต ะฟัะธะปะพะถะตะฝะธะต ะฝะต ะพัะฒะตัะฐะตั"
curl -f http://localhost:8081/api/health 2>/dev/null && echo "โ Streaming ัะตัะฒะธั ัะฐะฑะพัะฐะตั" || echo "โ Streaming ัะตัะฒะธั ะฝะต ะพัะฒะตัะฐะตั"

echo ""
echo "โ ะกะธััะตะผะฐ ะทะฐะฟััะตะฝะฐ!"
echo "๐ ะัะฝะพะฒะฝะพะน ะธะฝัะตััะตะนั: http://$SERVER_IP"
echo "๐บ ะัะพัะผะพัั ัััะธะผะพะฒ: http://$SERVER_IP/viewer.html"
echo "๐ง API health check: http://$SERVER_IP/api/health"
echo "๐ฅ Streaming service: http://$SERVER_IP:8081/api/health"
echo ""
echo "๐ ะะปั ะฟัะพัะผะพััะฐ ะปะพะณะพะฒ ะธัะฟะพะปัะทัะนัะต:"
echo "   cd deployments && docker-compose logs -f"
echo ""
echo "๐ ะะปั ะพััะฐะฝะพะฒะบะธ ะธัะฟะพะปัะทัะนัะต:"
echo "   cd deployments && docker-compose down"
